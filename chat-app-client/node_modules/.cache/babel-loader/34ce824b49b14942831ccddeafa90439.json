{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/\\u05E0\\u05E8\\u05D9\\u05D4/Desktop/chat rooms new/chat-app-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/\\u05E0\\u05E8\\u05D9\\u05D4/Desktop/chat rooms new/chat-app-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _objectSpread from\"C:/Users/\\u05E0\\u05E8\\u05D9\\u05D4/Desktop/chat rooms new/chat-app-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"C:/Users/\\u05E0\\u05E8\\u05D9\\u05D4/Desktop/chat rooms new/chat-app-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"C:/Users/\\u05E0\\u05E8\\u05D9\\u05D4/Desktop/chat rooms new/chat-app-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useEffect,useState,useRef}from\"react\";import{useLocation}from\"react-router\";import{decodeJwtToken,date}from\"../Utils/function\";import io from'socket.io-client';import{Container,Row}from\"react-bootstrap\";import InfiniteScrollReverse from\"react-infinite-scroll-reverse\";import{getMessges,getUsers,changeMessagesViewed}from\"../DAL/roomsApi\";import{BiMessageDetail}from\"react-icons/bi\";import{FaUsers}from\"react-icons/fa\";import{BsCheck}from\"react-icons/bs\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var socket;var morePagination=true;function Room(){var ENDPOINT=\"https://chat-rooms-web.herokuapp.com\";var messagesEndRef=useRef();var _decodeJwtToken=decodeJwtToken(),id=_decodeJwtToken.id,userName=_decodeJwtToken.userName;var _useLocation=useLocation(),state=_useLocation.state;var _useState=useState(state),_useState2=_slicedToArray(_useState,2),room=_useState2[0],setRoom=_useState2[1];// id, roomName, admin\nvar _useState3=useState(userName),_useState4=_slicedToArray(_useState3,2),name=_useState4[0],setName=_useState4[1];// userName\nvar _useState5=useState(true),_useState6=_slicedToArray(_useState5,2),isLoading=_useState6[0],setIsLoading=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),usersRoom=_useState8[0],setUsersRoom=_useState8[1];var _useState9=useState(true),_useState10=_slicedToArray(_useState9,2),bottom=_useState10[0],setBottom=_useState10[1];var _useState11=useState(''),_useState12=_slicedToArray(_useState11,2),message=_useState12[0],setMessage=_useState12[1];var _useState13=useState([]),_useState14=_slicedToArray(_useState13,2),messages=_useState14[0],setMessages=_useState14[1];var scrollToBottom=function scrollToBottom(){var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({});};useEffect(function(){scrollToBottom();},[bottom]);useEffect(function(){getListUsers();getMoreMessages(1);},[]);useEffect(function(){socket=io(ENDPOINT);socket.emit('join',{id:id,name:name,room:room},function(){});return function(){socket.emit('disconnection',{name:name,room:room},function(){});socket.off();};},[]);useEffect(function(){socket.on('message',function(_ref){var message=_ref.message;if(message.user===\"\"&&message.text===\"\"){// i joined\ngetListUsers();}else if(message.user===\"\"&&message.text!==\"\"){//else user joined or left\ngetListUsers();setMessages(function(messages){return[].concat(_toConsumableArray(messages),[message]);});}else{setMessages(function(messages){return[].concat(_toConsumableArray(messages),[message]);});setBottom(function(prev){return!prev;});// when get new mesage the scroller go bottom\n}});},[]);useEffect(function(){socket.on('changeViewed',function(_ref2){var messagesChanged=_ref2.messagesChanged;var messagesId=messagesChanged.map(function(message){if(message.userName===name){return message.id;}});setMessages(function(messages){return messages.map(function(message){if(messagesId.includes(message._id)){return _objectSpread(_objectSpread({},message),{},{view:true});}else{return message;}});});});},[]);function sendMessage(){if(message.trim()){var view;usersRoom.length>1?view=true:view=false;socket.emit('sendMessage',{name:name,room:room,message:message,view:view},function(){});setMessage(\"\");}}function getListUsers(){return _getListUsers.apply(this,arguments);}function _getListUsers(){_getListUsers=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var users;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getUsers(room.id);case 2:users=_context.sent;setUsersRoom(users);case 4:case\"end\":return _context.stop();}}},_callee);}));return _getListUsers.apply(this,arguments);}function getMoreMessages(_x){return _getMoreMessages.apply(this,arguments);}function _getMoreMessages(){_getMoreMessages=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(skip){var _yield$getMessges,lastData,nextMessages;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:setIsLoading(true);_context2.next=3;return getMessges(room.id,skip-1);case 3:_yield$getMessges=_context2.sent;lastData=_yield$getMessges.lastData;nextMessages=_yield$getMessges.nextMessages;setTimeout(function(){setMessages([].concat(_toConsumableArray(nextMessages),_toConsumableArray(messages)));setIsLoading(false);viewedMessages(nextMessages);},300);if(lastData){morePagination=false;}case 8:case\"end\":return _context2.stop();}}},_callee2);}));return _getMoreMessages.apply(this,arguments);}function viewedMessages(nextMessages){var messagesChanged=nextMessages.map(function(message){if(message.user!==name&&message.view===false){message.view=true;return{id:message._id,userName:message.user};}}).filter(function(message){return message!==undefined;});if(messagesChanged.length>0){socket.emit('changeViewedMessages',{room:room,messagesChanged:messagesChanged},function(){});changeMessagesViewed(messagesChanged);}}return/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsx(Container,{children:/*#__PURE__*/_jsxs(Row,{className:\"justify-content-center chat\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"chat-header\",children:/*#__PURE__*/_jsx(\"h4\",{className:\"text-center mt-2\",children:\"Chat Room\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-body\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-side-bar\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"name-room\",children:[/*#__PURE__*/_jsx(BiMessageDetail,{size:25,className:\"icon-msg\"}),\" \",/*#__PURE__*/_jsx(\"h6\",{children:\"Room Name :\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"header-room\",children:/*#__PURE__*/_jsx(\"h4\",{className:\"text-center\",children:room.roomName})}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"name-room mb-2\",children:[/*#__PURE__*/_jsx(FaUsers,{size:25,className:\"icon-msg\"}),/*#__PURE__*/_jsx(\"h6\",{children:\"Users :\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"users-room\",children:usersRoom.map(function(user,index){return/*#__PURE__*/_jsx(\"p\",{children:user.userName},index);})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-message-textArea\",children:[/*#__PURE__*/_jsx(InfiniteScrollReverse,{className:\"chat-messages\",hasMore:morePagination,isLoading:isLoading,loadMore:getMoreMessages,loadArea:50,children:messages.map(function(message,index){return/*#__PURE__*/_jsx(\"div\",{ref:index===messages.length-1?messagesEndRef:null,className:\"chat-out \".concat(message.user===name?\"left\":\"right\"),children:/*#__PURE__*/_jsxs(\"span\",{className:\"chat-rectangle \".concat(message.user===name?\"my-color\":\"other-color\"),children:[message.user&&/*#__PURE__*/_jsxs(\"p\",{className:\"chat-rectangle-name-date my-0 pt-1 pb-0\",children:[\" \",/*#__PURE__*/_jsx(\"span\",{children:message.user}),\" \",/*#__PURE__*/_jsx(\"span\",{children:date(message.date)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"d-flex justify-content-between\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"chat-rectangle-message\",children:message.text}),message.user===name&&/*#__PURE__*/_jsx(BsCheck,{size:30,className:\"\".concat(message.view?\"icon-v-view\":\"icon-v-not-view\",\" mt-0 mb-0\")})]})]})},index);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"textarea-message\",children:[/*#__PURE__*/_jsx(\"textarea\",{className:\"textArea\",rows:\"2\",value:message,onChange:function onChange(e){return setMessage(e.target.value);}}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-message\",variant:\"primary\",onClick:sendMessage,children:\"Send\"})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"chat-footer\",children:/*#__PURE__*/_jsxs(\"p\",{children:[\"Admin : \",room.admin.name]})})]})})});}export default Room;","map":{"version":3,"sources":["C:/Users/נריה/Desktop/chat rooms new/chat-app-client/src/chat/Components/Room.js"],"names":["useEffect","useState","useRef","useLocation","decodeJwtToken","date","io","Container","Row","InfiniteScrollReverse","getMessges","getUsers","changeMessagesViewed","BiMessageDetail","FaUsers","BsCheck","socket","morePagination","Room","ENDPOINT","messagesEndRef","id","userName","state","room","setRoom","name","setName","isLoading","setIsLoading","usersRoom","setUsersRoom","bottom","setBottom","message","setMessage","messages","setMessages","scrollToBottom","current","scrollIntoView","getListUsers","getMoreMessages","emit","off","on","user","text","prev","messagesChanged","messagesId","map","includes","_id","view","sendMessage","trim","length","users","skip","lastData","nextMessages","setTimeout","viewedMessages","filter","undefined","roomName","index","e","target","value","admin"],"mappings":"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","sourcesContent":["import { useEffect, useState, useRef } from \"react\"\r\nimport { useLocation } from \"react-router\"\r\nimport {decodeJwtToken, date} from \"../Utils/function\"\r\nimport io from 'socket.io-client'\r\nimport { Container, Row} from \"react-bootstrap\"\r\nimport InfiniteScrollReverse from \"react-infinite-scroll-reverse\"\r\nimport {getMessges, getUsers, changeMessagesViewed} from \"../DAL/roomsApi\"\r\nimport {BiMessageDetail} from \"react-icons/bi\"\r\nimport {FaUsers} from \"react-icons/fa\"\r\nimport {BsCheck} from \"react-icons/bs\"\r\n\r\n\r\nlet socket \r\nlet morePagination = true\r\n\r\nfunction Room(){\r\n\r\n    const ENDPOINT = \"https://chat-rooms-web.herokuapp.com\"\r\n    const messagesEndRef = useRef()\r\n    const {id, userName} = decodeJwtToken()\r\n    const {state} = useLocation()\r\n\r\n    const [room, setRoom] = useState(state) // id, roomName, admin\r\n    const [name, setName] = useState(userName) // userName\r\n    const [isLoading, setIsLoading] = useState(true)\r\n\r\n    const [usersRoom, setUsersRoom] = useState([])\r\n    const [bottom, setBottom] = useState(true)\r\n    const [message, setMessage] = useState('') \r\n    const [messages, setMessages] = useState([])\r\n\r\n\r\n\r\n    const scrollToBottom = () => {\r\n      messagesEndRef.current?.scrollIntoView({})\r\n    }\r\n\r\n    useEffect(()=>{scrollToBottom()}, [bottom])\r\n  \r\n    useEffect(()=>{\r\n        getListUsers()\r\n        getMoreMessages(1)\r\n    }, [])\r\n\r\n   \r\n    useEffect(()=>{\r\n        socket = io(ENDPOINT)\r\n        socket.emit('join', {id, name, room}, ()=>{\r\n        })\r\n\r\n        return () => {\r\n            socket.emit('disconnection', {name, room}, ()=>{\r\n            })\r\n\r\n            socket.off()\r\n        }\r\n    }, [])\r\n\r\n\r\n    useEffect(() => {\r\n        socket.on('message', ({message}) => {\r\n\r\n            if(message.user === \"\" && message.text === \"\") {  // i joined\r\n                getListUsers()\r\n\r\n            } else if(message.user === \"\" && message.text !== \"\"){ //else user joined or left\r\n                getListUsers()\r\n                setMessages(messages => [ ...messages, message ])\r\n\r\n            } else{\r\n                setMessages(messages => [ ...messages, message ])\r\n                setBottom(prev => !prev) // when get new mesage the scroller go bottom\r\n            }       \r\n        })\r\n    }, [])\r\n\r\n\r\n    useEffect(() => {\r\n        socket.on('changeViewed', ({messagesChanged}) => {\r\n\r\n            const messagesId = messagesChanged.map(message => {\r\n                if(message.userName === name){\r\n                    return message.id\r\n                }\r\n            })\r\n\r\n            setMessages(messages => messages.map(message => {\r\n                if (messagesId.includes(message._id)){\r\n                    return { ...message, view: true }\r\n                } else {\r\n                    return message\r\n                }\r\n            }))\r\n        })\r\n    },[])\r\n\r\n\r\n    function sendMessage(){\r\n        if(message.trim()){\r\n            let view \r\n            usersRoom.length > 1 ? view = true : view = false\r\n            socket.emit('sendMessage', {name, room, message, view}, ()=>{\r\n            })\r\n            setMessage(\"\")\r\n        }\r\n    }\r\n\r\n    async function getListUsers(){\r\n        const users = await getUsers(room.id) \r\n        setUsersRoom(users)\r\n    }\r\n\r\n    async function getMoreMessages(skip) {\r\n        setIsLoading(true)\r\n        const {lastData, nextMessages} = await getMessges(room.id, skip-1) \r\n\r\n        setTimeout(() => {\r\n            setMessages([...nextMessages, ...messages])\r\n            setIsLoading(false)\r\n            viewedMessages(nextMessages)\r\n        }, 300)\r\n\r\n        if(lastData) {\r\n            morePagination = false\r\n        }\r\n    }\r\n\r\n    function  viewedMessages(nextMessages){\r\n        const messagesChanged = nextMessages.map((message)=>{ \r\n            if(message.user !== name && message.view === false){\r\n                message.view = true \r\n                return {id: message._id, userName: message.user }\r\n            }\r\n        }).filter(message => message !== undefined)\r\n\r\n        if(messagesChanged.length > 0){\r\n\r\n            socket.emit('changeViewedMessages', {room, messagesChanged}, ()=>{\r\n            })\r\n\r\n            changeMessagesViewed(messagesChanged)\r\n        }\r\n    }\r\n\r\n\r\n    return <>\r\n        <Container>\r\n            <Row className=\"justify-content-center chat\">\r\n                <div className=\"chat-header\">\r\n                    <h4 className=\"text-center mt-2\">Chat Room</h4>\r\n                </div>\r\n\r\n                <div className=\"chat-body\">\r\n                    <div className=\"chat-side-bar\">\r\n                        <div className=\"name-room\">\r\n                            <BiMessageDetail size={25} className=\"icon-msg\"/> <h6>Room Name :</h6>\r\n                        </div>\r\n\r\n                        <div className=\"header-room\">\r\n                            <h4 className=\"text-center\">{room.roomName}</h4>\r\n                        </div>\r\n\r\n                        <div>\r\n                            <div className=\"name-room mb-2\">\r\n                                <FaUsers size={25} className=\"icon-msg\"/>\r\n                                 <h6>Users :</h6>\r\n                            </div>\r\n                            <div className=\"users-room\">\r\n                                {usersRoom.map((user, index)=> <p key = {index}>{user.userName}</p>)}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"chat-message-textArea\">\r\n                        <InfiniteScrollReverse\r\n                        className=\"chat-messages\"\r\n                        hasMore={morePagination}\r\n                        isLoading={isLoading}\r\n                        loadMore={getMoreMessages}\r\n                        loadArea={50}\r\n                        >\r\n                            \r\n                            {messages.map((message, index)=>{\r\n                                return  <div key={index} ref = {index === messages.length-1 ? messagesEndRef : null } className={`chat-out ${message.user === name ? \"left\" : \"right\" }`}> \r\n                                            <span className={`chat-rectangle ${message.user === name ? \"my-color\" : \"other-color\" }`}>\r\n                                                {message.user&&<p className=\"chat-rectangle-name-date my-0 pt-1 pb-0\"> <span>{message.user}</span> <span>{date(message.date)}</span></p>}\r\n                                                <div className=\"d-flex justify-content-between\">\r\n                                                    <p className=\"chat-rectangle-message\">{message.text}</p>\r\n                                                    {message.user===name&&<BsCheck size = {30} className={`${message.view ? \"icon-v-view\" : \"icon-v-not-view\"} mt-0 mb-0`}/>}                                         \r\n                                                </div>\r\n                                            </span>\r\n                                        </div> \r\n                            })}\r\n                        \r\n                        </InfiniteScrollReverse>\r\n\r\n                        <div className=\"textarea-message\">\r\n                            <textarea className=\"textArea\" rows=\"2\" value={message} onChange={(e)=>setMessage(e.target.value)}/>\r\n                            <button className=\"btn-message\" variant=\"primary\" onClick = {sendMessage}>Send</button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                </div>\r\n\r\n                <div className=\"chat-footer\">\r\n                    <p>Admin : {room.admin.name}</p>\r\n                </div>\r\n            </Row>\r\n        </Container>\r\n    </>\r\n}\r\n\r\nexport default Room"]},"metadata":{},"sourceType":"module"}